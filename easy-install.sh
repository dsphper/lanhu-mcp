#!/bin/bash

# è“æ¹– MCP Server - è¶…çº§ç®€å•å®‰è£…è„šæœ¬
# ä¸“ä¸ºå°ç™½ç”¨æˆ·è®¾è®¡ï¼Œäº¤äº’å¼å¼•å¯¼å®‰è£…

set -e

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# æ¸…å±
clear

echo -e "${BOLD}${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                   â•‘"
echo "â•‘     ðŸŽ¨ è“æ¹– MCP Server - ä¸€é”®å®‰è£…ç¨‹åº            â•‘"
echo "â•‘                                                   â•‘"
echo "â•‘     è®© AI åŠ©æ‰‹å…±äº«å›¢é˜ŸçŸ¥è¯†ï¼Œæ‰“ç ´ AI IDE å­¤å²›     â•‘"
echo "â•‘                                                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo ""
echo -e "${GREEN}æ¬¢è¿Žï¼è¿™ä¸ªè„šæœ¬ä¼šå¸®ä½ è‡ªåŠ¨å®Œæˆæ‰€æœ‰å®‰è£…æ­¥éª¤${NC}"
echo -e "${GREEN}é¢„è®¡è€—æ—¶ï¼š3-5 åˆ†é’Ÿ${NC}"
echo ""
echo -e "æŒ‰ ${BOLD}Enter${NC} å¼€å§‹å®‰è£…ï¼Œæˆ–æŒ‰ ${BOLD}Ctrl+C${NC} å–æ¶ˆ"
read

# ============================================
# æ­¥éª¤ 1: çŽ¯å¢ƒæ£€æŸ¥
# ============================================

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸ“¦ æ­¥éª¤ 1/5: æ£€æŸ¥ç³»ç»ŸçŽ¯å¢ƒ${NC}"
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# æ£€æŸ¥ Python
echo -e "æ­£åœ¨æ£€æŸ¥ Python..."
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ æœªæ£€æµ‹åˆ° Python 3${NC}"
    echo ""
    echo "è¯·å…ˆå®‰è£… Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼š"
    echo "  Mac: brew install python3"
    echo "  Ubuntu: sudo apt install python3 python3-pip"
    echo "  å®˜ç½‘: https://www.python.org/downloads/"
    exit 1
fi

PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
echo -e "${GREEN}âœ… Python $PYTHON_VERSION${NC}"

# æ£€æŸ¥ pip
if ! command -v pip3 &> /dev/null; then
    echo -e "${RED}âŒ æœªæ£€æµ‹åˆ° pip3${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… pip3 å·²å®‰è£…${NC}"

# æ£€æŸ¥ Git
if ! command -v git &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  æœªæ£€æµ‹åˆ° Gitï¼ˆå¯é€‰ï¼‰${NC}"
else
    echo -e "${GREEN}âœ… Git å·²å®‰è£…${NC}"
fi

echo ""
echo -e "${GREEN}ðŸŽ‰ çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼${NC}"
sleep 1

# ============================================
# æ­¥éª¤ 2: å®‰è£…ä¾èµ–
# ============================================

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸ“¥ æ­¥éª¤ 2/5: å®‰è£…ä¾èµ–åŒ…${NC}"
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
if [ ! -d "venv" ]; then
    echo "æ­£åœ¨åˆ›å»º Python è™šæ‹ŸçŽ¯å¢ƒ..."
    python3 -m venv venv
    echo -e "${GREEN}âœ… è™šæ‹ŸçŽ¯å¢ƒåˆ›å»ºå®Œæˆ${NC}"
else
    echo -e "${GREEN}âœ… è™šæ‹ŸçŽ¯å¢ƒå·²å­˜åœ¨${NC}"
fi

# æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ
echo "æ­£åœ¨æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ..."
source venv/bin/activate

# å‡çº§ pip
echo "æ­£åœ¨å‡çº§ pip..."
pip install --upgrade pip -q

# å®‰è£…ä¾èµ–
echo "æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
echo -e "${YELLOW}ï¼ˆè¿™å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ï¼‰${NC}"
pip install -r requirements.txt -q

echo -e "${GREEN}âœ… ä¾èµ–å®‰è£…å®Œæˆ${NC}"

# å®‰è£… Playwright æµè§ˆå™¨
echo ""
echo "æ­£åœ¨å®‰è£… Playwright æµè§ˆå™¨..."
echo -e "${YELLOW}ï¼ˆé¦–æ¬¡å®‰è£…éœ€è¦ä¸‹è½½ Chromiumï¼Œå¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿï¼‰${NC}"
playwright install chromium

echo ""
echo -e "${GREEN}ðŸŽ‰ ä¾èµ–å®‰è£…å®Œæˆï¼${NC}"
sleep 1

# ============================================
# æ­¥éª¤ 3: èŽ·å–è“æ¹– Cookieï¼ˆäº¤äº’å¼ï¼‰
# ============================================

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸª æ­¥éª¤ 3/5: èŽ·å–è“æ¹– Cookie${NC}"
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${YELLOW}è¿™æ˜¯å”¯ä¸€éœ€è¦ä½ æ‰‹åŠ¨æ“ä½œçš„æ­¥éª¤ï¼Œå¾ˆç®€å•ï¼${NC}"
echo ""
echo -e "${BOLD}è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š${NC}"
echo ""
echo -e "  1ï¸âƒ£  åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š${BOLD}${BLUE}https://lanhuapp.com${NC} å¹¶ç™»å½•"
echo ""
echo -e "  2ï¸âƒ£  æŒ‰ä¸‹é”®ç›˜ ${BOLD}F12${NC} é”®ï¼ˆMac ç”¨æˆ·æŒ‰ ${BOLD}Command+Option+I${NC}ï¼‰"
echo "     ä¼šæ‰“å¼€å¼€å‘è€…å·¥å…·"
echo ""
echo -e "  3ï¸âƒ£  ç‚¹å‡»é¡¶éƒ¨çš„ ${BOLD}\"Network\"${NC}ï¼ˆç½‘ç»œï¼‰æ ‡ç­¾"
echo ""
echo -e "  4ï¸âƒ£  æŒ‰ ${BOLD}F5${NC} åˆ·æ–°é¡µé¢"
echo ""
echo -e "  5ï¸âƒ£  åœ¨å·¦ä¾§è¯·æ±‚åˆ—è¡¨ä¸­ç‚¹å‡» ${BOLD}ç¬¬ä¸€ä¸ªè¯·æ±‚${NC}"
echo ""
echo -e "  6ï¸âƒ£  å³ä¾§æ‰¾åˆ° ${BOLD}\"Request Headers\"${NC} éƒ¨åˆ†"
echo "     æ‰¾åˆ° \"Cookie:\" å¼€å¤´çš„é‚£ä¸€è¡Œ"
echo ""
echo -e "  7ï¸âƒ£  ${BOLD}é€‰ä¸­å¹¶å¤åˆ¶${NC} æ•´ä¸ª Cookie å€¼"
echo "     ï¼ˆCookie å¾ˆé•¿ï¼Œç¡®ä¿å…¨éƒ¨å¤åˆ¶ï¼‰"
echo ""
echo -e "${BOLD}${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# å¦‚æžœç³»ç»Ÿæ”¯æŒï¼Œå°è¯•æ‰“å¼€æµè§ˆå™¨
if command -v open &> /dev/null; then
    echo -e "æˆ‘å¯ä»¥å¸®ä½ æ‰“å¼€è“æ¹–ç½‘ç«™å—ï¼Ÿ(y/n) [${BOLD}y${NC}]: "
    read -r open_browser
    open_browser=${open_browser:-y}
    if [ "$open_browser" = "y" ] || [ "$open_browser" = "Y" ]; then
        open "https://lanhuapp.com" 2>/dev/null || true
        echo -e "${GREEN}âœ… å·²æ‰“å¼€æµè§ˆå™¨${NC}"
        echo ""
    fi
fi

echo -e "${BOLD}å¤åˆ¶å¥½ Cookie åŽï¼Œç²˜è´´åˆ°ä¸‹é¢ï¼š${NC}"
echo -e "${YELLOW}(æç¤º: ç²˜è´´æ—¶ä¸ä¼šæ˜¾ç¤ºå†…å®¹ï¼Œç›´æŽ¥ç²˜è´´åŽæŒ‰ Enter)${NC}"
echo ""
echo -n "> "
read -r LANHU_COOKIE

# éªŒè¯ Cookie ä¸ä¸ºç©º
if [ -z "$LANHU_COOKIE" ]; then
    echo -e "${RED}âŒ Cookie ä¸èƒ½ä¸ºç©º${NC}"
    exit 1
fi

# ç®€å•éªŒè¯ Cookie æ ¼å¼
if [[ ! "$LANHU_COOKIE" =~ "session=" ]] && [[ ! "$LANHU_COOKIE" =~ "user_token=" ]]; then
    echo -e "${YELLOW}âš ï¸  Cookie æ ¼å¼å¯èƒ½ä¸æ­£ç¡®${NC}"
    echo "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(y/n) [n]: "
    read -r continue_anyway
    if [ "$continue_anyway" != "y" ] && [ "$continue_anyway" != "Y" ]; then
        echo "å®‰è£…å·²å–æ¶ˆ"
        exit 1
    fi
fi

echo ""
echo -e "${GREEN}âœ… Cookie å·²æŽ¥æ”¶ï¼${NC}"
sleep 1

# ============================================
# æ­¥éª¤ 4: ç”Ÿæˆé…ç½®æ–‡ä»¶
# ============================================

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}âš™ï¸  æ­¥éª¤ 4/5: ç”Ÿæˆé…ç½®æ–‡ä»¶${NC}"
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# åˆ›å»º .env æ–‡ä»¶
cat > .env << EOF
# è“æ¹– MCP æœåŠ¡å™¨é…ç½®
# ç”± easy-install.sh è‡ªåŠ¨ç”Ÿæˆ

# ==============================================
# å¿…éœ€é…ç½®
# ==============================================

# è“æ¹– Cookieï¼ˆå¿…éœ€ï¼‰
LANHU_COOKIE="$LANHU_COOKIE"

# ==============================================
# æœåŠ¡å™¨é…ç½®
# ==============================================

SERVER_HOST="0.0.0.0"
SERVER_PORT=8000

# ==============================================
# æ•°æ®å­˜å‚¨
# ==============================================

DATA_DIR="./data"

# ==============================================
# æ€§èƒ½é…ç½®
# ==============================================

HTTP_TIMEOUT=30
VIEWPORT_WIDTH=1920
VIEWPORT_HEIGHT=1080

# ==============================================
# è°ƒè¯•é€‰é¡¹
# ==============================================

DEBUG="false"

EOF

echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ${NC}"

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data logs
echo -e "${GREEN}âœ… æ•°æ®ç›®å½•å·²åˆ›å»º${NC}"

sleep 1

# ============================================
# æ­¥éª¤ 5: å¯åŠ¨æœåŠ¡
# ============================================

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸš€ æ­¥éª¤ 5/5: å¯åŠ¨æœåŠ¡${NC}"
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${GREEN}æ˜¯å¦çŽ°åœ¨å¯åŠ¨æœåŠ¡ï¼Ÿ(y/n) [${BOLD}y${NC}]: ${NC}"
read -r start_now
start_now=${start_now:-y}

if [ "$start_now" = "y" ] || [ "$start_now" = "Y" ]; then
    echo ""
    echo -e "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${GREEN}ðŸŽ‰ å®‰è£…æˆåŠŸï¼æœåŠ¡æ­£åœ¨å¯åŠ¨...${NC}"
    echo -e "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}æœåŠ¡å™¨åœ°å€ï¼š${NC}http://localhost:8000/mcp"
    echo ""
    echo -e "${BOLD}ä¸‹ä¸€æ­¥ï¼šåœ¨ Cursor ä¸­é…ç½® MCP${NC}"
    echo ""
    echo "è¯·å°†ä»¥ä¸‹é…ç½®æ·»åŠ åˆ° Cursor çš„ MCP é…ç½®æ–‡ä»¶ä¸­ï¼š"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    cat << 'MCP_CONFIG'
{
  "mcpServers": {
    "lanhu": {
      "url": "http://localhost:8000/mcp?role=å¼€å‘&name=ä½ çš„åå­—"
    }
  }
}
MCP_CONFIG
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}é…ç½®æ–¹æ³•ï¼š${NC}"
    echo "  1. æ‰“å¼€ Cursor"
    echo "  2. æŒ‰ Command+Shift+P (Mac) æˆ– Ctrl+Shift+P (Windows)"
    echo "  3. è¾“å…¥ 'MCP' æ‰¾åˆ° MCP é…ç½®"
    echo "  4. ç²˜è´´ä¸Šé¢çš„é…ç½®"
    echo ""
    echo -e "æŒ‰ ${BOLD}Ctrl+C${NC} å¯ä»¥åœæ­¢æœåŠ¡å™¨"
    echo ""
    echo -e "${GREEN}æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨...${NC}"
    echo ""
    
    # è¿è¡ŒæœåŠ¡å™¨
    python lanhu_mcp_server.py
else
    echo ""
    echo -e "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${GREEN}ðŸŽ‰ å®‰è£…æˆåŠŸï¼${NC}"
    echo -e "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "ç¨åŽè¿è¡ŒæœåŠ¡å™¨ï¼Œè¯·æ‰§è¡Œï¼š"
    echo -e "  ${BOLD}source venv/bin/activate${NC}"
    echo -e "  ${BOLD}python lanhu_mcp_server.py${NC}"
    echo ""
fi

